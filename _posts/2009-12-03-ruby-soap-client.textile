---                                                                                                                                                          
layout: post
title: soap客户端
---
h2. 选择

ruby带有soap4r的插件，可以用于访问web service服务接口，但不支持basic_auth、WS-Security
因此选用handsoap作为客户端插件

h2. 安装

<pre>
sudo gem install handsoap curb nokogiri httpclient --no-ri --no-rdoc
#如果安装curb过程报cannot find -lcur错误，则运行
sudo apt-get install libcurl4-openssl-dev
</pre>

<pre>
#environment.rb中加入
config.gem 'handsoap', :lib => 'handsoap', :source => "http://gems.github.com"
</pre>

h2. 使用

<pre>
#生成客户端类
script/generate handsoap http://192.168.1.20:8081/cmis/webService/ciisStatService?wsdl
</pre>

##### 配置管理员需要配置的地方在这里(用户、密码、接口地址) ######
<pre>
#生成的连接地址加入environments/production.rb中
CIIS_USERNAME = 'cogent'
CIIS_PASSWORD = 'cogent'

CIIS_STAT_SERVICE_IMPL_SERVICE_ENDPOINT = {
  :uri => 'http://192.168.1.20:8081/cmis/webService/ciisStatService',
  :version => 1
}
</pre>

<pre>
#script/console
s = Ciis::PopService.find_pop '%'
#获取列表对象
s.list
#获取列表对象中的内容
s.list.first.name
#获取属性值
s.size
</pre>

h2. 调试

使用soapui访问webservice接口，确保服务正常
为了监控客户端与服务器的交互内容，可使用tcpmon架设代理

"soapui":http://sourceforge.net/projects/soapui/files/soapui/3.0.1
"tcpmon":https://tcpmon.dev.java.net

h2. 问题

<pre>
#按照handsoap官方说明无法实现ws-security的访问
#提示Security processing failed (actions mismatch)
#经过尝试，以下调用是成功的
  def on_create_document(doc)
    #register namespaces for the request
    doc.alias 'tns', 'http://ws.stat.wsif.cogent.com/'
    doc.alias 's', 'http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd'
    header = doc.find("Header")
    header.add "s:Security" do |s| 
      #增加此节点，否则会报错
      s.add "s:UsernameToken" do |t|                                                                                                                         
        t.add "s:Username", "cogent"
        t.add "s:Password", "cogent"
      end 
    end 
  end
</pre>
